
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Convert Tools - POLYTRON KUPANG (Spaced Grid)</title>

<!-- Library Eksternal -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
    :root {
        /* --- WARNA SESUAI LOGO (POLYTRON RED) --- */
        --primary-color: #d32f2f; 
        --primary-hover: #b71c1c;
        --danger-color: #dc2626;
        --danger-hover: #991b1b;
        
        --bg-color: #f3f4f6;
        --surface-color: #ffffff;
        --text-color: #1f2937;
        --border-color: #cbd5e1;
        --guide-line: #374151; 
    }

    * { box-sizing: border-box; }

    body {
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        padding: 20px;
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
    }

    /* --- CONTROLS & HEADER (TAMPILAN LEBIH PIPIH) --- */
    .controls {
        background: var(--surface-color);
        padding: 20px 30px; /* Padding vertikal dikurangi drastis */
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        width: 100%;
        max-width: 900px;
        display: flex; 
        align-items: center; /* Pusatkan vertikal agar rapi */
        justify-content: flex-start; 
        gap: 30px; /* Jarak antar elemen dikurangi */
        text-align: left; 
        border-top: 6px solid var(--primary-color);
    }

    /* --- UKURAN LOGO LEBIH KECIL --- */
    .brand-logo {
        max-height: 80px; /* Dikurangi dari 120px */
        width: auto;
        object-fit: contain;
        flex-shrink: 0; 
    }

    .control-content {
        flex: 1; 
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    /* --- UKURAN FONT DIKECILKAN --- */
    .controls h1 { 
        margin: 0 0 2px 0; 
        font-size: 1.4rem; /* Dikurangi sedikit */
        color: #111827; 
        font-weight: 700;
        line-height: 1.2;
    }
    
    .controls .subtitle {
        color: var(--primary-color);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px; /* Jarak dikurangi */
        font-size: 0.75rem; /* Font lebih kecil */
    }

    .controls p { 
        color: #6b7280; 
        margin-bottom: 12px; /* Margin bawah dikurangi */
        font-size: 0.85rem; /* Font deskripsi lebih kecil */
        max-width: 600px; 
        line-height: 1.4;
    }

    /* --- INPUT GROUP --- */
    .input-group {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap; 
    }

    .button-group {
        display: flex;
        gap: 8px; /* Jarak antar tombol dirapatkan */
        flex-shrink: 0;
    }

    input[type="file"] {
        padding: 8px 15px; /* Padding input dikurangi */
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        background: #f9fafb;
        color: #4b5563;
        font-size: 0.85rem; /* Font teks input lebih kecil */
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
        max-width: 300px;
        flex: 1;
        min-width: 180px;
        height: 42px; /* Tinggi tetap agar sejajar dengan tombol */
    }

    input[type="file"]:hover { 
        border-color: var(--primary-color); 
        background: #fff5f5; 
        color: var(--primary-color);
    }

    button {
        padding: 10px 18px; /* Padding tombol dikurangi sedikit */
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem; /* Font tombol lebih kecil */
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        white-space: nowrap;
        height: 42px; /* Tinggi tombol disamakan dengan input */
    }

    .btn-primary { 
        background-color: var(--primary-color); 
        color: white; 
        box-shadow: 0 4px 6px rgba(211, 47, 47, 0.3); 
    }
    .btn-primary:hover { 
        background-color: var(--primary-hover); 
        transform: translateY(-1px); 
    }

    .btn-danger { 
        background-color: white; 
        color: #555; 
        border: 1px solid #d1d5db; 
    }
    .btn-danger:hover { 
        background-color: #fee2e2; 
        color: var(--danger-color); 
        border-color: var(--danger-color); 
    }

    button:disabled { 
        opacity: 0.6; 
        cursor: not-allowed; 
        transform: none !important; 
        background-color: #e5e7eb;
        color: #9ca3af;
    }

    /* --- PREVIEW AREA --- */
    #preview-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 40px;
        padding-bottom: 60px;
        overflow-x: auto;
    }

    .empty-state {
        margin-top: 40px; /* Margin atas dikurangi */
        text-align: center; 
        color: #9ca3af;
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        gap: 15px;
        border: 2px dashed #e5e7eb;
        padding: 30px;
        border-radius: 12px;
        background: white;
    }
    .empty-state svg { width: 50px; height: 50px; color: #d1d5db; }

    /* --- A4 PAGE & GRID --- */
    .page {
        width: 210mm; 
        min-height: 297mm;
        background: white;
        padding: 8mm; 
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        position: relative;
        border: 1px solid #e5e7eb;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        width: 100%; 
        height: 100%;
        gap: 6px; 
        border: none; 
    }

    .photo-box {
        position: relative; 
        width: 100%; 
        height: 100%;
        overflow: hidden;
        background-color: #fff;
        display: flex; 
        align-items: center; 
        justify-content: center;
        border: 2px solid var(--guide-line);
    }

    .photo-box img { 
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
        display: block; 
        filter: contrast(1.05) brightness(1.05); 
    }

    /* --- LOADER & TOAST --- */
    .toast {
        position: fixed; bottom: 30px; left: 50%;
        transform: translateX(-50%) translateY(20px);
        background-color: #1f2937; color: white;
        padding: 12px 24px; border-radius: 50px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        opacity: 0; visibility: hidden; transition: all 0.3s;
        z-index: 9999; font-size: 0.9rem;
        font-weight: 500;
    }
    .toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .toast.success { border-left: 5px solid #10b981; }
    .toast.error { border-left: 5px solid #ef4444; }

    .loader-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95);
        display: none; flex-direction: column;
        justify-content: center; align-items: center; z-index: 10000;
    }
    .spinner {
        width: 50px; height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    #loaderText { margin-top: 20px; font-weight: 600; color: #374151; font-size: 1.1rem; }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
        .controls {
            flex-direction: column;
            text-align: center;
            gap: 15px;
            padding: 20px; /* Padding mobile dirapatkan */
        }
        
        .brand-logo {
            margin-bottom: 5px;
            max-height: 70px;
        }

        .control-content {
            width: 100%;
        }

        .input-group {
            flex-direction: column;
            width: 100%;
            align-items: stretch;
        }

        .button-group {
            width: 100%;
            justify-content: center;
        }
        
        input[type="file"], button {
            width: 100%;
            justify-content: center;
        }
    }
</style>
</head>

<body>

<div class="controls">
    <!-- Logo Diganti dengan URL baru -->
    <img src="https://z-cdn-media.chatglm.cn/files/02a082e5-7ac0-466b-8f5a-eb8818b9bfc5.png?auth_key=1871210249-de7f9ce57c7c4fe9af5a8bea171e5501-0-1ad493ae9c80be929686f9e239a339e9" alt="POLYTRON Logo" class="brand-logo" onerror="this.style.display='none'">
    
    <!-- Konten -->
    <div class="control-content">
        <div class="subtitle">Internal Tools - POLYTRON KUPANG</div>
        <h1>CONVERT TOOLS</h1>
        <p>Unggah Foto atau File PDF (Auto-convert ke JPG). Sistem akan menyusun otomatis ke format A4.
</p>
        
        <div class="input-group">
            <input type="file" id="upload" multiple accept="image/*, .pdf" title="Pilih Foto atau PDF">
            
            <!-- Button Group -->
            <div class="button-group">
                <button id="btnDownload" class="btn-primary" onclick="generatePDF()" disabled>
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Download PDF
                </button>

                <button id="btnReset" class="btn-danger" onclick="resetData()" disabled>
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Hapus Data
                </button>
            </div>
        </div>
    </div>
</div>

<div id="preview-container">
    <div class="empty-state" id="emptyState">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
        <p>Belum ada data. Silakan upload Foto atau PDF.</p>
    </div>
</div>

<!-- Toast & Loader -->
<div id="toast" class="toast">Notifikasi</div>
<div id="loader" class="loader-overlay">
    <div class="spinner"></div>
    <p id="loaderText">Memproses...</p>
</div>

<script>
    // --- SETUP PDF JS ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // --- VARIABLES ---
    const uploadInput = document.getElementById("upload");
    const previewContainer = document.getElementById("preview-container");
    const emptyState = document.getElementById("emptyState");
    const btnDownload = document.getElementById("btnDownload");
    const btnReset = document.getElementById("btnReset");
    const toastEl = document.getElementById("toast");
    const loaderEl = document.getElementById("loader");
    const loaderText = document.getElementById("loaderText");

    // --- TOAST FUNCTION ---
    function showToast(message, type = 'normal', duration = 3000) {
        toastEl.textContent = message;
        toastEl.className = 'toast show'; 
        if (type === 'success') toastEl.classList.add('success');
        if (type === 'error') toastEl.classList.add('error');
        setTimeout(() => { toastEl.classList.remove("show"); }, duration);
    }

    // --- FUNGSI UTAMA: PROSES FILE ---
    uploadInput.addEventListener("change", async (e) => {
        const files = [...e.target.files];
        if (files.length === 0) return;

        loaderEl.style.display = 'flex';
        loaderText.textContent = "Menganalisis file...";

        emptyState.style.display = 'none';
        previewContainer.innerHTML = '';
        btnDownload.disabled = false;
        btnReset.disabled = false;

        let allImages = []; 

        try {
            for (const file of files) {
                if (file.type === 'application/pdf') {
                    loaderText.textContent = `Mengkonversi ${file.name} (High Res)...`;
                    const pdfImages = await convertPdfToImages(file);
                    allImages = allImages.concat(pdfImages);
                } else if (file.type.startsWith('image/')) {
                    loaderText.textContent = `Memuat gambar ${file.name}...`;
                    const imgBase64 = await readImageAsBase64(file);
                    allImages.push(imgBase64);
                } else {
                    console.warn("Format file tidak didukung:", file.name);
                }
            }

            if (allImages.length === 0) {
                showToast("Tidak ada gambar valid yang ditemukan.", 'error');
                resetData();
                return;
            }

            renderLayout(allImages);
            showToast(`Berhasil memproses ${allImages.length} foto.`, 'success');

        } catch (error) {
            console.error(error);
            showToast("Terjadi kesalahan saat memproses file.", 'error');
            resetData();
        } finally {
            loaderEl.style.display = 'none';
        }
    });

    // --- KONVERSI PDF HIGH RES ---
    async function convertPdfToImages(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        const images = [];
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2.0 });
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport: viewport }).promise;
            images.push(canvas.toDataURL('image/jpeg', 1.0));
        }
        return images;
    }

    function readImageAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsDataURL(file);
        });
    }

    function renderLayout(images) {
        const perPage = 9;
        
        for (let i = 0; i < images.length; i += perPage) {
            const page = document.createElement("div");
            page.className = "page";
            
            const grid = document.createElement("div");
            grid.className = "grid";

            const pageImages = images.slice(i, i + perPage);

            pageImages.forEach(imgSrc => {
                const box = document.createElement("div");
                box.className = "photo-box";

                const img = document.createElement("img");
                img.src = imgSrc;
                
                box.appendChild(img);
                grid.appendChild(box);
            });

            const emptySlots = perPage - pageImages.length;
            if (emptySlots > 0) {
                for (let k = 0; k < emptySlots; k++) {
                    const emptyBox = document.createElement("div");
                    emptyBox.className = "photo-box";
                    emptyBox.style.background = "#fafafa";
                    grid.appendChild(emptyBox);
                }
            }

            page.appendChild(grid);
            previewContainer.appendChild(page);
        }
    }

    function resetData() {
        const hasContent = previewContainer.querySelector(".page");
        if (!hasContent) {
            showToast("Tidak ada data untuk dihapus.", 'error');
            return;
        }
        if (confirm("Apakah Anda yakin ingin menghapus semua data?")) {
            uploadInput.value = "";
            previewContainer.innerHTML = "";
            previewContainer.appendChild(emptyState);
            emptyState.style.display = 'flex';
            btnDownload.disabled = true;
            btnReset.disabled = true;
            showToast("Semua data telah dihapus.");
        }
    }

    async function generatePDF() {
        const pages = document.querySelectorAll(".page");
        if (pages.length === 0) {
            showToast("Tidak ada halaman untuk diunduh.", 'error');
            return;
        }

        loaderEl.style.display = 'flex';
        loaderText.textContent = "Sedang membuat PDF High Definition...";
        btnDownload.disabled = true;
        btnReset.disabled = true;

        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("p", "mm", "a4");
            const pageWidth = 210;
            const pageHeight = 297;

            for (let i = 0; i < pages.length; i++) {
                const canvas = await html2canvas(pages[i], { 
                    scale: 3, 
                    useCORS: true,
                    logging: false,
                    backgroundColor: "#ffffff"
                });
                
                const imgData = canvas.toDataURL("image/jpeg", 0.95);

                if (i > 0) pdf.addPage();
                pdf.addImage(imgData, "JPEG", 0, 0, pageWidth, pageHeight);
            }

            pdf.save("LABEL KOMPONEN BEKAS.pdf");
            showToast("PDF berhasil diunduh!", "success");

        } catch (error) {
            console.error(error);
            showToast("Terjadi kesalahan saat membuat PDF.", "error");
        } finally {
            loaderEl.style.display = 'none';
            btnDownload.disabled = false;
            btnReset.disabled = false;
        }
    }
</script>

</body>
</html>
